<link href="catalog/view/javascript/paymee/css/skeleton/normalize.css?v={{ versao }}" rel="stylesheet" type="text/css" />
<link href="catalog/view/javascript/paymee/css/skeleton/skeleton.css?v={{ versao }}" rel="stylesheet" type="text/css" />
<style>
  #responsivo .button.button-primary,
  #responsivo button.button-primary,
  #responsivo input[type="submit"].button-primary,
  #responsivo input[type="reset"].button-primary,
  #responsivo input[type="button"].button-primary {
    color: {{ cor_normal_texto }};
    background-color: {{ cor_normal_fundo }};
    border-color: {{ cor_normal_borda }};
  }
  #responsivo .button.button-primary:hover,
  #responsivo button.button-primary:hover,
  #responsivo input[type="submit"].button-primary:hover,
  #responsivo input[type="reset"].button-primary:hover,
  #responsivo input[type="button"].button-primary:hover,
  #responsivo .button.button-primary:focus,
  #responsivo button.button-primary:focus,
  #responsivo input[type="submit"].button-primary:focus,
  #responsivo input[type="reset"].button-primary:focus,
  #responsivo input[type="button"].button-primary:focus {
    color: {{ cor_efeito_texto }};
    background-color: {{ cor_efeito_fundo }};
    border-color: {{ cor_efeito_borda }};
  }
</style>
<div id="responsivo">
  <p style="text-align: center;"><img src="{{ logo }}" border="0" /></p>
  <p style="text-align: center; font-size: 14px; font-weight: 600; color: #666666;">{{ text_metodo }}</p>
  <form onkeypress="return event.keyCode != 13" id="payment">
    <div class="row-form" id="metodos"></div>
    <div id="dados_conta">
      <hr>
      <p style="text-align: center; font-size: 14px; font-weight: 600; color: #666666;">{{ text_dados }}</p>
      <div class="row-form">
        <div class="five columns value">
          <label class="u-full-width" for="input-agencia"><strong>{{ entry_agencia }}</strong></label>
          <input type="text" name="agencia" value="" placeholder="" id="input-agencia" maxlength="6" autocomplete="off" class="u-full-width" />
        </div>
        <div class="five columns value">
          <label class="u-full-width" for="input-conta"><strong>{{ entry_conta }}</strong></label>
          <input type="text" name="conta" value="" placeholder="" id="input-conta" maxlength="15" autocomplete="off" class="u-full-width" />
        </div>
      </div>
      <div class="row-form">
        <div class="twelve columns value" id="termos-dados">
          <input type="checkbox" name="dados" id="input-dados" value="Sim"> {{ termos_dados }}
        </div>
      </div>
    </div>
    <div class="row-form">
      <div class="twelve columns value" id="termos-aceito">
        <input type="checkbox" name="input-aceito" id="input-aceito" value="Sim"> {{ termos_aceito }}
      </div>
    </div>
    <div class="row-form">
      <div class="twelve columns value" id="termos-prazo">
        <input type="checkbox" name="input-prazo" id="input-prazo" value="Sim"> {{ termos_prazo }}
      </div>
    </div>
    {% if sandbox %}
    <div class="alert alert-warning">{{ text_sandbox }}</div>
    {% else %}
    <h4>&nbsp;</h4>
    {% endif %}
    <p style="text-align: center;"><input class="button-primary" value="{{ button_confirm }}" id="button-confirm" data-loading-text="{{ text_aguarde }}" type="button"></p>
  </form>
</div>
<script type="text/javascript"><!--
  $('#dados_conta').show();

  $('#metodos').on('change', '#input-metodo', function() {
    if ($(this).val() == 'ITAU_DI') {
      $('#dados_conta').hide();
    } else if ($(this).val() == 'SANTANDER_DI') {
      $('#dados_conta').hide();
    } else if ($(this).val() == 'PIX') {
      $('#dados_conta').hide();
    } else {
      $('#dados_conta').show();
    }
  });

  $('#input-agencia').on('keyup change', function() {
    $(this).val($(this).val().replace(/[^\d-]/g,''));
  });

  $('#input-conta').on('keyup change', function() {
    $(this).val($(this).val().replace(/[^\d-]/g,''));
  });

  $('#button-confirm').on('click', function() {
    validar($(this));
  });

  function metodos() {
    json = {{ metodos }};

    html = '';
    for (i = 0; i <= json.length-1; i++) {
      html += '<div class="three columns value" style="margin-bottom: 20px; text-align: center;">';
      if (i == '0') {
        html += '<input type="radio" name="metodo" id="input-metodo" value="'+ json[i]['metodo'] +'" checked />';
      } else {
        html += '<input type="radio" name="metodo" id="input-metodo" value="'+ json[i]['metodo'] +'" />';
      }
      html += '<img alt="' + json[i]['alt'] + '" title="' + json[i]['alt'] + '" src="'+ json[i]['imagem'] +'" border="0" /> ';
      html += '<strong>' + json[i]['titulo'] + '</strong>';
      html += '</div>';
    }

    $('#metodos').html(html);
  };

  metodos();

  $('#input-metodo').trigger('change');

  function transacao(campo) {
    $('.alert-danger').remove();

    $.ajax({
      url: 'index.php?route=extension/payment/paymee/transacao',
      type: 'post',
      data: $('#payment input[type="text"], #payment input[type="radio"]:checked'),
      dataType: 'json',
      beforeSend: function() {
        $('#button-confirm').button('loading');
        $("input").prop("disabled", true);
      },
      complete: function() {
        $('#button-confirm').button('reset');
        $("input").prop("disabled", false);
      },
      success: function(json) {
        if (json) {
          if (json['error']) {
            $('#payment').before('<div class="alert alert-danger">'+json['error']+'</div>');
          } else {
            $('#payment').hide();
            $('#payment').before('<div class="alert alert-success">{{ text_redirecionando }}</div>');
            location.href = json['redirect'];
          }
        } else {
          $('#payment').before('<div class="alert alert-danger">{{ error_configuracao }}</div>');
        }
      },
      error: function(jqXHR, textStatus, errorThrown) {
        if (jqXHR.status == 200 || jqXHR.status == 404 || jqXHR.status == 500 || errorThrown == 'Not Found') {
          $('#payment').before('<div class="alert alert-danger">{{ error_configuracao }}</div>');
        }
      }
    });
  };

  function validar(campo) {
    var erros = 0;
    var metodo = $('input[name=metodo]:checked').val();

    if ($('#input-aceito').is(':checked')) {
      $('#termos-aceito').removeClass('alert-danger');
    } else {
      $('#termos-aceito').addClass('alert-danger');
      erros++;
    }

    if ($('#input-prazo').is(':checked')) {
      $('#termos-prazo').removeClass('alert-danger');
    } else {
      $('#termos-prazo').addClass('alert-danger');
      erros++;
    }

    if (metodo != 'ITAU_DI' && metodo != 'SANTANDER_DI' && metodo != 'PIX') {
      var campos = {
        agencia: '{{ error_agencia }}',
        conta: '{{ error_conta }}'
      };

      if ($('#input-dados').is(':checked')) {
        $('#termos-dados').removeClass('alert-danger');
      } else {
        $('#termos-dados').addClass('alert-danger');
        erros++;
      }

      $('div .text-danger').each(function() { $(this).remove(); });
      $('#payment input[type="text"]').removeClass('alert-danger');

      $('#payment input[type="text"]').each(function(){
        for(var chave in campos){
          if ($(this).attr("name") == chave) {
            if ($.trim($(this).val()).length == 0) {
              $(this).toggleClass('alert-danger');
              $(this).after('<div class="text-danger">'+campos[chave]+'</div>');
              erros++;
            } else {
              $(this).removeClass('alert-danger');
            }
          }
        }
      });
    }

    if (erros == 0) {
      transacao(campo);
    } else {
      return false;
    };
  };
//--></script>
